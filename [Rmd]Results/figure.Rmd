---
title: "Result notes"
author: "Yuta Suzuki"
date: "4/23/2021"
output: 
  word_document
  # slidy_presentation:
  #   css: style.css
params:
  year: 2021
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r child="readFunc.Rmd"}
```

## Article information

Pupil response asymmetries of the periphery visual field in the glare illusion

Novera Istiqomah, Yuta Suzuki, Yuya Kinzuka, Minami Tetsuto, Shigeki Nakauchi

*Corresponding author: Yuta Suzuki


```{r, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}
################ generate dataset file ################
# sTime = -1
# eTime = 4
# timeLen = c(sTime,eTime)
# nameOfVar = c("condition","condition")
# f1 = "Locs"
# f2 = "Pattern"
# 
# g1 <- rep(c("Upper","Lower","Center","Left","Right"),2)
# g2 <- rep(c("Glare","Control"), times=c(5,5))
# 
# go1 <- c("Upper","Lower","Center","Left","Right")
# go2 <- c("Glare","Control")
# 
# ################ making dataset for e1 ##################
# data=fromJSON(file="../[python]pre_processing/data/data20211124.json")
# dat <- list((matrix(unlist(data$PDR),nrow=length(data$PDR),byrow=T)),
#             t(unlist(data$sub)),
#             t(unlist(data$condition)))
# names(dat) <- c('y', 'sub', 'condition')
# 
# ind_data = makePupilDataset_mat2long(dat,c('condition','condition'),timeLen,list(g1,g2),list(go1,go2),c(f1,f2))
# 
# data_e1 = aggregate( . ~ sub*data_x*Locs*Pattern, data = ind_data, FUN = "mean")
# 
# data_e1$minLatency = data$min
# 
# #### file loading #### 
# data_e1$Locs = factor(data_e1$Locs, go1)
# numOfSub = length(unique(data_e1$sub))
# 
# data_auc = data.frame()
# for(iSub in unique(data_e1$sub)){
#   for(iLocs in unique(data_e1$Locs)){
#     for(iPattern in unique(data_e1$Pattern)){
#       tmp = data_e1[data_e1$sub == iSub &
#                       data_e1$Locs == iLocs &
#                       data_e1$Pattern == iPattern,]
#       tmp = tmp[tmp$data_x > tmp$minLatency[1],]
# 
#       peakMin = data_e1[data_e1$sub == iSub &
#                           data_e1$Locs == iLocs &
#                           data_e1$Pattern == iPattern,]
#       peakMin =  mean(peakMin[peakMin$data_x < tmp$minLatency[1]+0.25 &
#                                 peakMin$data_x > tmp$minLatency[1]-0.25,]$data_y)
#       auc = 0
#       for(ix in 1:(length(tmp$data_x))){
#         auc = auc + ((tmp[ix,]$data_y-peakMin)*(1/500))
#       }
#       data_auc = rbind(data_auc,data.frame(
#         sub = iSub,
#         Locs = iLocs,
#         Pattern = iPattern,
#         data_y = c(peakMin,auc),
#         comp = c('Early','Late')
#       ))
#     }
#   }
# }
# 
# # save(data_auc,file = "./data/data_auc20211124.rda")
# save(data_e1,data_auc,file = "./data/dataset20211124.rda")

```

```{r, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}
countFigNum = 1

go1 <- c("Center","Upper","Lower","Left","Right")
######## file loading ########
load("./data/dataset20211124.rda")
data_e1$Locs = factor(data_e1$Locs, go1)
numOfSub = length(unique(data_e1$sub))
sTime = -0.2
eTime = max(data_e1$data_x)

anovaTabAll = list()

######## Figure 2A ########
data_e1_ave = aggregate( data_y ~ data_x*Locs*Pattern, data = data_e1, FUN = "mean")

config = list(lim_x = c(sTime, eTime),
              lim_y = c(-0.5, 0.7),
              alpha = 0.4,
              stride = 0.1,
              label_x = "Time [sec]",
              label_y = "Pupil Changes [z-scored]",
              title = "",
              linetype = TRUE,
              grCol = rep(c("#101010","#101010"),10),
              gr_outline =  rep(c("#101010","#101010"),10)
)

p <- disp(data_e1,config,1,c("Pattern","Locs"))
p <- p +
  facet_grid(. ~ Locs)

config$ylim = round(seq(-0.5,0.75,0.25),2)
config$ylim_stride = 0.05
config$xlim = round(seq(0,4,1),2)
config$xlim_stride = 0.5
p = setEmptyStyle(p,config)

p = p +
  theme(
    axis.ticks = element_line(colour = "black",size = 0.5),
    legend.text = element_text(size = 7),
    legend.position = c(1, 0),
    legend.justification = c(1, 0)
  )


data_e1_center = data_e1[data_e1$data_x >= 0 & data_e1$Locs == 'Center',]
data_e1_center = aggregate( data_y ~ sub*data_x*Pattern, data = data_e1_center, FUN = "mean")
data_e1_center = aggregate( data_y ~ sub*Pattern, data = data_e1_center, FUN = "mean")

x = data_e1_center[data_e1_center$Pattern == 'Glare',]$data_y
y = data_e1_center[data_e1_center$Pattern == 'Control',]$data_y

cohen_d = cohen.d(x,y,paired=TRUE, within=TRUE)
bf = ttestBF(x = x, y = y, paired=TRUE)

center_table = list(list(
  anovaTab = t.test(x,y,var.equal=T,paired=T),
  cohend = round(abs(cohen_d[["estimate"]]),3),
  bf = round(exp(bf@bayesFactor[["bf"]]),3)
))
names(center_table) <- c('center_table')

anovaTabAll = c(anovaTabAll,center_table)


######## Figure 2A ########
data_auc$Locs = factor(data_auc$Locs, go1)
data_center = data_auc[data_auc$Locs == 'Center',]

config = list(
  alpha = 0.4,
  stride = 0.1,
  label_x = "",
  label_y = "Pupil Changes [z-score]",
  title = "",
  grCol = rep(c("white","black"),5),
  gr_outline =  rep(c("black","black"),5)
)

#### Figure 3A (center early) #### 
p <- dispLineGraph(data_center[data_center$comp == 'Early',],config,c("Locs","Pattern"))+
  facet_grid(. ~ Locs)+
  ggtitle('Early')

config$ylim = round(seq(-0.5,0,0.1),2)
config$ylim_stride = 0.05
config$xlim = round(seq(1,2,1),2)
config$xlim_stride = 0.5

p = setEmptyStyle(p,config)

p <- p + theme(
  axis.title.x=element_blank(),
  axis.text.x=element_blank(),
  axis.ticks.x = element_blank()
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

#### Figure 3A (late early) #### 
config$label_y = "AUC [z-score]"

p <- dispLineGraph(data_center[data_center$comp == 'Late',],config,c("Locs","Pattern"))+
  facet_grid(. ~ Locs)+
  ggtitle('Late')

config$ylim = round(seq(0.5,1.5,0.5),2)
config$ylim_stride = 0.05
config$xlim = round(seq(1,2,1),2)
config$xlim_stride = 0.5

p = setEmptyStyle(p,config)

p <- p + theme(
  axis.title.x=element_blank(),
  axis.text.x=element_blank(),
  axis.ticks.x = element_blank()
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

#### Figure 3BC #### 
data_auc = data_auc[data_auc$Locs != 'Center',]

config$label_y = "Pupil Changes [z-score]"

p <- dispLineGraph(data_auc[data_auc$comp == 'Early',],config,c("Locs","Pattern"))+
  facet_grid(. ~ Locs)+
  ggtitle('Early')

config$ylim = round(seq(-0.2,0.2,0.1),2)
config$ylim_stride = 0.05
config$xlim = round(seq(1,2,1),2)
config$xlim_stride = 0.5

p = setEmptyStyle(p,config)
p <- p + theme(
  axis.title.x=element_blank(),
  axis.text.x=element_blank(),
  axis.ticks.x = element_blank()
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

#### Figure 3B #### 
config$label_y = "AUC [z-score]"

p <- dispLineGraph(data_auc[data_auc$comp == 'Late',],config,c("Locs","Pattern"))+
  facet_grid(. ~ Locs)+
  ggtitle('Late(AUC)')

config$ylim = round(seq(0,1.2,0.2),2)
config$ylim_stride = 0.15
config$xlim = round(seq(1,2,1),2)
config$xlim_stride = 0.5

p = setEmptyStyle(p,config)
p <- p + theme(
  axis.title.x=element_blank(),
  axis.text.x=element_blank(),
  axis.ticks.x = element_blank()
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

#### Early component ANOVA #### 

data_anova = data_auc[data_auc$comp == 'Early',]
data_anova$comp = NULL

anovakun(data_anova,"sAB",long=T, peta=T, gg=T)

data_anova$Locs = factor(data_anova$Locs,levels = unique(data_anova$Locs))
data_anova$Pattern = factor(data_anova$Pattern,levels = unique(data_anova$Pattern))
data_anova$sub = factor(data_anova$sub,levels = unique(data_anova$sub))

data_anova_Early_BF = anovaBF(data_y ~ Locs*Pattern + sub, data=data_anova, whichRandom = "sub")

fig3a_anovatable = forDrawingSigANOVA
fig3a_ttest = forDrawingPost[["A"]][["bontab"]]
fig3a_inter = forDrawingPost[["A:B"]][["simtab"]]

data_anova_Early = list(list(
  anovaTab = forDrawingSigANOVA,
  post = forDrawingPost[["A"]][["bontab"]],
  bf = round(exp(data_anova_Early_BF@bayesFactor[["bf"]]),3),
  fig3a_ttest = fig3a_ttest,
  fig3a_inter = fig3a_inter
))

names(data_anova_Early) <- c('data_anova_Early')
anovaTabAll = c(anovaTabAll,data_anova_Early)

#### Late component ANOVA #### 
data_anova = data_auc[data_auc$comp == 'Late',]
data_anova$comp = NULL
anovakun(data_anova,"sAB",long=T, peta=T, gg=T)

data_anova$Locs = factor(data_anova$Locs,levels = unique(data_anova$Locs))
data_anova$Pattern = factor(data_anova$Pattern,levels = unique(data_anova$Pattern))
data_anova$sub = factor(data_anova$sub,levels = unique(data_anova$sub))

data_anova_Late_BF = anovaBF(data_y ~ Locs*Pattern + sub, data=data_anova, whichRandom = "sub")

fig3b_anovatable = forDrawingSigANOVA
fig3b_ttest = forDrawingPost[["A"]][["bontab"]]
fig3b_inter = forDrawingPost[["A:B"]][["simtab"]]

data_anova_Late = list(list(
  anovaTab = forDrawingSigANOVA,
  post = forDrawingPost[["A"]][["bontab"]],
  bf = round(exp(data_anova_Late_BF@bayesFactor[["bf"]]),3),
  fig3b_ttest = fig3b_ttest,
  fig3b_inter = fig3b_inter
))

names(data_anova_Late) <- c('data_anova_Late')
anovaTabAll = c(anovaTabAll,data_anova_Late)


```

## Results
We presented the glare illusion and halo stimuli at one out of five VF locations (i.e., upper, lower, left, right, and center). As reported previously, enhanced pupil constriction in the Center condition was observed shown in Fig.2A 
($t$(`r anovaTabAll[["center_table"]][["anovaTab"]][["parameter"]][["df"]]`) = 
`r round(anovaTabAll[["center_table"]][["anovaTab"]][["statistic"]][["t"]],3)`, 
$p$ = `r round(anovaTabAll[["center_table"]][["anovaTab"]][["p.value"]],3)`, 
Cohenâ€™s  $d_z$ = `r anovaTabAll[["center_table"]][["cohend"]]`, 
$BF_{10}$ =  `r anovaTabAll[["center_table"]][["bf"]]`)

To assess temporal component of papillary response, the early component corresponded to peak pupil constriction after stimulus onset and the late comportment which was defined by are under the curve (AUC) were calculated (see Method). In early component (Fig 3B), pupil constriction to the glare illusion was larger than control pattern as the previous analysis 
The two-way repeated measures ANOVA revealed a significant main effect on the pattern and VF locations ($F$(`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][4,]['df.col'],3)`, 
`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][5,]['df.col'],3)`) = 
`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][4,]['f.col'],3)`, 
p = `r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][4,]['p.col'],3)`, 
$\eta^2_p$ =  `r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][4,]['p.eta^2'],3)`; 
$BF_{10}$ =  `r anovaTabAll[["data_anova_Early"]][["bf"]][2]`, 
$F$(`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][2,]['df.col'],3)`, 
`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][3,]['df.col'],3)`) = 
`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][2,]['f.col'],3)`, 
p = `r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][2,]['p.col'],3)`, 
$\eta^2_p$ =  `r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][2,]['p.eta^2'],3)`, 
$BF_{10}$ =  `r anovaTabAll[["data_anova_Early"]][["bf"]][1]`). 
However, the post-hoc multiple comparisons for the VF locations showed that any pair of VF loaction did not reach the significance level (p > 0.05).
There was no significant interaction between the pattern and VF locations 
($F$(`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][6,]['df.col'],3)`, 
`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][7,]['df.col'],3)`) = 
`r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][6,]['f.col'],3)`, 
p = `r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][6,]['p.col'],3)`, 
$\eta^2_p$ =  `r round(anovaTabAll[["data_anova_Early"]][["anovaTab"]][6,]['p.eta^2'],3)`, 
$BF_{10}$ =  `r  round(anovaTabAll[["data_anova_Early"]][["bf"]][4]/anovaTabAll[["data_anova_Early"]][["bf"]][3],3)`).

The two-way repeated measures ANOVA revealed a significant main effect on the VF location and interaction 
($F$(`r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['df.col'],3)`, 
`r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][3,]['df.col'],3)`) = 
`r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['f.col'],3)`, 
p = `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['p.col'],3)`, 
$\eta^2_p$ =  `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['p.eta^2'],3)`, 
$BF_{10}$ =  `r anovaTabAll[["data_anova_Late"]][["bf"]][1]`; 
$F$(`r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][6,]['df.col'],3)`, 
`r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][7,]['df.col'],3)`) = 
`r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][6,]['f.col'],3)`, 
p = `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][6,]['p.col'],3)`, 
$\eta^2_p$ =  `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][6,]['p.eta^2'],3)`, 
$BF_{10}$ =  `r  round(anovaTabAll[["data_anova_Late"]][["bf"]][4]/anovaTabAll[["data_anova_Late"]][["bf"]][3],3)`).
The UVF produces larger pupil dilation than the left and Right VFs
($t$(`r anovaTabAll[["data_anova_Late"]][["fig3b_ttest"]][1,]['df']`) = 
`r round(anovaTabAll[["data_anova_Late"]][["fig3b_ttest"]][1,]['t'],3)`, 
$p$ = `r round(anovaTabAll[["data_anova_Late"]][["fig3b_ttest"]][1,]['adj.p'],3)`; 
)
in line with the previous studies __(Hong et al., 2001; Sabeti et al., 2011; Tan et al., 2001; Wilhelm et al., 2000)__.




<!-- There was no significant main effect on the pattern   -->
<!-- ($F$(`r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['df.col'],3)`,  -->
<!-- `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][3,]['df.col'],3)`) =  -->
<!-- `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['f.col'],3)`,  -->
<!-- p = `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['p.col'],3)`,  -->
<!-- $\eta^2_p$ =  `r round(anovaTabAll[["data_anova_Late"]][["anovaTab"]][2,]['p.eta^2'],3)`,  -->
<!-- $BF_{10}$ =  `r anovaTabAll[["data_anova_Late"]][["bf"]][1]`). -->

<!-- There was no significant interaction between visual field and stimulus pattern  -->
<!-- ($F$(`r round(fig3a_anovatable[6,]['df.col'],3)`,  -->
<!-- `r round(fig3a_anovatable[7,]['df.col'],3)`) = `r round(fig3a_anovatable[6,]['f.col'],3)`,  -->
<!-- p = `r round(fig3a_anovatable[6,]['p.col'],3)`,  -->
<!-- $\eta^2_p$ =  `r round(fig3a_anovatable[6,]['p.eta^2'],3)`).  -->

<!-- In late component, there was a significant interaction between visual field and stimulus pattern ($F$(`r round(fig3b_anovatable[6,]['df.col'],3)`, `r round(fig3b_anovatable[7,]['df.col'],3)`) = `r round(fig3b_anovatable[6,]['f.col'],3)`, p = `r round(fig3b_anovatable[6,]['p.col'],3)`, $\eta^2_p$ =  `r round(fig3b_anovatable[6,]['p.eta^2'],3)`). Crucial, the significant differences of pupil response between glare and control stimuli was seen only in the UVF (F(1,`r round(fig3b_inter[6,]['df.col'],3)`) = `r round(fig3b_inter[5,]['f.col'],3)`,p = `r round(fig3b_inter[5,]['p.col'],3)`, $\eta^2_p$ =  `r round(fig3b_inter[5,]['p.eta^2'],3)`).  -->

$$
AUC = \sum_{i=0.787}^4 x_i-x_{0.787}
$$

## Figure 3
```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.height=5, fig.width=13}
p = combineGraphs(seq(1,2),'p',NULL)
width_fig=5
height_fig=3
CairoPDF(file="figure/fig3A",
         width=width_fig, height=height_fig)
print(p)
dev.off()

p = combineGraphs(seq(3,4),'p',NULL)
width_fig=13
height_fig=5
CairoPDF(file="figure/fig3BC",
         width=width_fig, height=height_fig)
print(p)
dev.off()
```